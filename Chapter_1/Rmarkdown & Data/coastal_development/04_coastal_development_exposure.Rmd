---
title: "Coastal Development Exposure in the Saguenay Fjord"
author: "Hediyeh Yazdanpanah"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    highlight: pygments
    theme: yeti
    toc: TRUE
    toc_depth: 4
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
    df_print: paged
    fig_caption: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = TRUE,
  message = TRUE,
  error = TRUE,
  fig.width = 10,
  fig.height = 8
)

# SET WORKING DIRECTORY (note: coastal_development without special character)
knitr::opts_knit$set(root.dir = "/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/Rmarkdown & Data/coastal_development")

# Source shared functions (this will load all required packages)
#source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shared_functions.R")
#source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shared_functions_0.00025.R")
source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shered_functions_0.00001.R")

# Load ONLY the extra packages needed for THIS specific analysis
library(RColorBrewer)
library(viridis)
```

# Introduction

Coastal development represents a significant environmental stressor in the Saguenay Fjord through multiple pathways including light pollution, urban runoff, sedimentation, chemical contamination, and physical habitat alteration. This analysis quantifies coastal development exposure using nightlight satellite data as a proxy for human settlement density and infrastructure development.

## Nightlight Data as Development Proxy

Following established methodologies (Halpern et al., 2008), artificial nighttime illumination provides an objective, consistent measure of coastal urbanization intensity. Nightlight data effectively captures the spatial extent and intensity of human settlements, infrastructure, and economic activity in coastal zones. Unlike binary classification approaches, this analysis **preserves actual light intensity values** to weight the contribution of each settlement proportionally to its development level.

## Data Sources

Nightlight raster data were obtained from the **Knowledge Network for Bioinformatics** repository, providing global coverage of artificial light emissions validated for marine impact assessments.

## Methodology Overview

1. **Coastal Buffer Definition**: 500m buffer from shoreline (0m bathymetric contour)
2. **Light Source Identification**: 75th percentile threshold (top 25% of light intensity)
3. **Intensity Preservation**: Actual light intensity values retained throughout analysis
4. **Point Source Conversion**: Raster aggregation (2x factor) and conversion to intensity-weighted point sources
5. **Spatial Clustering**: 500m radius clustering groups nearby sources while preserving spatial distribution
6. **Cluster Representation**: Brightest point per cluster retained to ensure locations remain on actual coastal settlements
7. **Intensity Weighting**: Each cluster weighted by cumulative intensity of all constituent sources
8. **Spatial Decay Modeling**: Level III decay function for medium-range coastal effects with intensity-based weighting
# Data Loading

## Base Data

```{r load-base-data}
# bathy.tif is in the coastal_development folder
bathy_path <- "/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/Rmarkdown & Data/coastal_development/bathy.tif"

bathy_data <- load_bathymetry(bathy_path = bathy_path)
bathy_200 <- bathy_data$bathy_200
water_mask <- bathy_data$water_mask
water_sf <- bathy_data$water_sf
```

## Nightlight Data

```{r load-nightlight-data}
# nightlights.tif is in the coastal_development folder
nightlight_path <- "/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/Rmarkdown & Data/coastal_development/nightlights.tif"

light_raster <- raster::raster(nightlight_path)

# Project to UTM and crop to study area
if (raster::projection(light_raster) != target_crs) {
  light_utm <- raster::projectRaster(light_raster, crs = target_crs)
  light_crop <- raster::crop(light_utm, raster::extent(xmin, xmax, ymin, ymax))
} else {
  light_crop <- raster::crop(light_raster, raster::extent(xmin, xmax, ymin, ymax))
}

# Resample to 200m resolution
light_200 <- raster::projectRaster(light_crop, crs = target_crs, res = c(200, 200))
```

# Coastal Zone and Light Source Identification

## Shoreline Extraction and Buffering

```{r define-coastal-zone}
# Extract 0m contour as shoreline
shoreline <- raster::rasterToContour(bathy_200, levels = 0)
shoreline_sf <- st_as_sf(shoreline)

# Create 500m coastal buffer
coastal_buffer <- st_buffer(shoreline_sf, dist = 500)
coastal_buffer_sp <- as(coastal_buffer, "Spatial")
```

## Light Source Identification

Main light sources are identified using a **75th percentile threshold**, focusing on areas of significant development intensity (top 25% of light values within the coastal buffer). Sources are then **clustered spatially** and weighted by their actual light intensity values.

```{r identify-light-sources}
# ===============================================================================
# EXTRACT INTENSITY VALUES (NOT BINARY)
# ===============================================================================

# Mask nightlight to coastal buffer
light_coastal <- raster::mask(light_200, coastal_buffer_sp)

# Calculate 75th percentile threshold
light_threshold <- quantile(values(light_coastal), probs = 0.75, na.rm = TRUE)

# Keep only values above threshold (KEEP INTENSITY, don't convert to binary)
light_sources_intensity <- light_coastal
light_sources_intensity[light_sources_intensity < light_threshold] <- NA

# Aggregate to reduce points
light_sources_agg <- raster::aggregate(light_sources_intensity, fact = 2, fun = mean)

# Convert to points WITH intensity values
light_source_df <- raster::rasterToPoints(light_sources_agg, spatial = FALSE) %>%
  as.data.frame()

colnames(light_source_df) <- c("x", "y", "light_intensity")

# Convert to sf with intensity
light_source_points <- light_source_df %>%
  st_as_sf(coords = c("x", "y"), crs = target_crs)

# Calculate intensity index (0-1 scale)
max_light <- max(light_source_points$light_intensity, na.rm = TRUE)
light_source_points$intensity_index <- light_source_points$light_intensity / max_light

cat("Initial light sources above threshold:", nrow(light_source_points), "\n")
cat("Intensity range:", 
    round(min(light_source_points$intensity_index), 3), "-",
    round(max(light_source_points$intensity_index), 3), "\n")

# ===============================================================================
# SPATIAL CLUSTERING - KEEP HIGHEST INTENSITY POINT PER CLUSTER
# ===============================================================================

library(dbscan)

# Cluster nearby light sources (500m radius)
coords_matrix <- st_coordinates(light_source_points)
clusters <- dbscan(coords_matrix, eps = 500, minPts = 1)

cat("Created", max(clusters$cluster), "spatial clusters\n")

# Keep brightest point per cluster and sum intensities
light_source_clustered <- light_source_points %>%
  mutate(cluster = clusters$cluster) %>%
  group_by(cluster) %>%
  arrange(desc(intensity_index)) %>%
  mutate(
    total_cluster_intensity = sum(intensity_index),
    n_sources = n()
  ) %>%
  slice(1) %>%  # Keep brightest point (stays on actual settlement)
  ungroup() %>%
  mutate(intensity_index = total_cluster_intensity)

# Renormalize
max_intensity <- max(light_source_clustered$intensity_index)
light_source_clustered$intensity_index <- light_source_clustered$intensity_index / max_intensity

# Use clustered points
light_source_points <- light_source_clustered

cat("\n=== CLUSTERING SUMMARY ===\n")
cat("Final clusters:", nrow(light_source_points), "\n")
cat("Average sources per cluster:", round(mean(light_source_points$n_sources), 1), "\n")
cat("Total original sources:", sum(light_source_points$n_sources), "\n")
cat("Intensity range:", 
    round(min(light_source_points$intensity_index), 3), "-",
    round(max(light_source_points$intensity_index), 3), "\n")
```

## Setup Grid and Transition Layer

```{r setup-exposure}
# Create water-only grid (much faster than full study area grid)
water_polygon_sf <- raster::rasterToPolygons(water_mask, dissolve = TRUE) %>%
  st_as_sf()

grid_res <- 200
grid_water <- st_make_grid(water_polygon_sf,
                           cellsize = grid_res,
                           what = "centers") %>%
  st_sf() %>%
  st_intersection(water_polygon_sf)

# Create water-only transition layer
tr_water <- create_water_transition(bathy_200)

# Create template raster
template_raster <- create_template_raster(bathy_200)

```

## Calculate Intensity-Weighted Coastal Development Exposure
```{r calculate-intensity-weighted-exposure}
# Set decay type
decay_type <- "III"

# Calculate individual exposures
light_exposures <- list()

for (i in 1:nrow(light_source_points)) {
  cat("Processing cluster", i, "of", nrow(light_source_points), 
      "- Intensity:", round(light_source_points$intensity_index[i], 3),
      "- Sources:", light_source_points$n_sources[i], "\n")
  
  intensity <- light_source_points$intensity_index[i]
  
  # Calculate exposure for this cluster
  single_exp <- RelativeExposure(
    source = light_source_points[i,],
    transition = tr_water,
    decay_type = decay_type,
    grid_points_sf = grid_water,
    empty_raster = template_raster
  )
  
  # Weight by intensity
  light_exposures[[i]] <- single_exp * intensity
}

# ===============================================================================
# COMBINE AND NORMALIZE WITH PROPER MASKING
# ===============================================================================

# Filter out any NULL exposures 
valid_exposures <- light_exposures[!sapply(light_exposures, is.null)]

# Combine all weighted exposures
combined_exposure <- Reduce('+', valid_exposures)

# Normalize to 0-1 scale
max_val <- cellStats(combined_exposure, stat = "max", na.rm = TRUE)
combined_exposure <- combined_exposure / max_val

# Create fjord mask: TRUE for any area with bathymetry data (water OR land)
fjord_mask <- !is.na(bathy_200)

# Verify the mask
cat("Fjord mask check:\n")
print(table(values(fjord_mask), useNA = "always"))

# Apply intelligent masking:
# 1. In water areas with 0 exposure: set to small value (shows as light gray)
combined_exposure[fjord_mask & combined_exposure == 0] <- 0.0001

# 2. In land areas: set to NA (shows as white)
combined_exposure[!fjord_mask] <- NA

# Final exposure
coastal_exp <- combined_exposure

```


# Results Visualization

## Coastal Development Exposure

```{r plot-coastal-exposure, fig.cap="Coastal development exposure using binary nightlight classification with Level III decay"}
#png("coastal_development_0.00001.png")
plot_exposure(coastal_exp,
              "Coastal Development Exposure -  inensity approach (Level III)",
              xmin, xmax, ymin, ymax)
#dev.off()
```


# Save Results

```{r save-results}
# Save exposure raster
writeRaster(coastal_exp,
            filename = "coastal_development_exposure.tif",
            overwrite = TRUE)

# Save source points
st_write(light_source_points,
         "coastal_light_sources.gpkg",
         delete_dsn = TRUE)

# Save workspace
save(coastal_exp,
     light_source_points,
     coastal_buffer,
     file = "coastal_development_exposure.RData")
```


# References

Halpern, B. S., Walbridge, S., Selkoe, K. A., Kappel, C. V., Micheli, F., D'Agrosa, C., ... & Watson, R. (2008). A global map of human impact on marine ecosystems. *Science*, 319(5865), 948-952.

Knowledge Network for Bioinformatics. (2019). *Global nightlight raster data for marine impact assessment*. https://knb.ecoinformatics.org/view/doi:10.5063/F19Z92TW

Davies, T. W., Duffy, J. P., Bennie, J., & Gaston, K. J. (2014). The nature, extent, and ecological implications of marine light pollution. *Frontiers in Ecology and the Environment*, 12(6), 347-355.

Navara, K. J., & Nelson, R. J. (2007). The dark side of light at night: physiological, epidemiological, and ecological consequences. *Journal of Pineal Research*, 43(3), 215-224.

---

**Session Info:**
```{r session-info}
sessionInfo()
```