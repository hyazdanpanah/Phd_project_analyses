---
title: "Coastal Development Exposure in the Saguenay Fjord"
author: "Hediyeh Yazdanpanah"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    highlight: pygments
    theme: yeti
    toc: TRUE
    toc_depth: 4
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
    df_print: paged
    fig_caption: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = TRUE,
  message = TRUE,
  error = TRUE,
  fig.width = 10,
  fig.height = 8
)

# SET WORKING DIRECTORY (note: coastal_development without special character)
knitr::opts_knit$set(root.dir = "/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/Rmarkdown & Data/coastal_development")

# Source shared functions (this will load all required packages)
#source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shared_functions.R")
#source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shared_functions_0.00025.R")
source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shered_functions_0.00001.R")

# Load ONLY the extra packages needed for THIS specific analysis
library(RColorBrewer)
library(viridis)
library(dbscan)
```

# Introduction

Coastal development represents a significant environmental stressor in the Saguenay Fjord through multiple pathways including light pollution, urban runoff, sedimentation, chemical contamination, and physical habitat alteration. This analysis quantifies coastal development exposure using nightlight satellite data as a proxy for human settlement density and infrastructure development.

## Nightlight Data as Development Proxy

Following established methodologies (Halpern et al., 2008), artificial nighttime illumination provides an objective, consistent measure of coastal urbanization intensity. Nightlight data effectively captures the spatial extent and intensity of human settlements, infrastructure, and economic activity in coastal zones. Unlike binary classification approaches, this analysis **preserves actual light intensity values** to weight the contribution of each settlement proportionally to its development level.

## Data Sources

Nightlight raster data were obtained from the **Knowledge Network for Bioinformatics** repository, providing global coverage of artificial light emissions validated for marine impact assessments.

## Methodology Overview

1. **Coastal Buffer Definition**: 500m buffer from shoreline (0m bathymetric contour)
2. **Light Source Identification**: 75th percentile threshold (top 25% of light intensity)
3. **Intensity Preservation**: Actual light intensity values retained throughout analysis
4. **Point Source Conversion**: Raster aggregation (2x factor) and conversion to intensity-weighted point sources
5. **Spatial Clustering**: 500m radius clustering groups nearby sources while preserving spatial distribution
6. **Cluster Representation**: Brightest point per cluster retained to ensure locations remain on actual coastal settlements
7. **Intensity Weighting**: Each cluster weighted by cumulative intensity of all constituent sources
8. **Spatial Decay Modeling**: Level III decay function for medium-range coastal effects with intensity-based weighting
# Data Loading

## Base Data

```{r load-base-data}
# bathy.tif is in the coastal_development folder
bathy_path <- "/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/Rmarkdown & Data/coastal_development/bathy.tif"

bathy_data <- load_bathymetry(bathy_path = bathy_path)
bathy_200 <- bathy_data$bathy_200
water_mask <- bathy_data$water_mask
water_sf <- bathy_data$water_sf
```

## Nightlight Data

```{r load-nightlight-data}
# nightlights.tif is in the coastal_development folder
nightlight_path <- "/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/Rmarkdown & Data/coastal_development/nightlights.tif"

light_raster <- raster::raster(nightlight_path)

# Project to UTM and crop to study area
if (raster::projection(light_raster) != target_crs) {
  light_utm <- raster::projectRaster(light_raster, crs = target_crs)
  light_crop <- raster::crop(light_utm, raster::extent(xmin, xmax, ymin, ymax))
} else {
  light_crop <- raster::crop(light_raster, raster::extent(xmin, xmax, ymin, ymax))
}

# Resample to 200m resolution
light_200 <- raster::projectRaster(light_crop, crs = target_crs, res = c(200, 200))
```

# Coastal Zone and Light Source Identification

## Shoreline Extraction and Buffering

```{r define-coastal-zone}
# Extract 0m contour as shoreline
shoreline <- raster::rasterToContour(bathy_200, levels = 0)
shoreline_sf <- st_as_sf(shoreline)

# Create 500m coastal buffer
coastal_buffer <- st_buffer(shoreline_sf, dist = 500)
coastal_buffer_sp <- as(coastal_buffer, "Spatial")
```

## Light Source Identification

Main light sources are identified using a **75th percentile threshold**, focusing on areas of significant development intensity (top 25% of light values within the coastal buffer). Sources are then **clustered spatially** and weighted by their actual light intensity values.

```{r identify-light-sources}
# ===============================================================================
# IDENTIFY LIGHT SOURCES WITH SECTION-SPECIFIC THRESHOLDS
# ===============================================================================

# Mask nightlight to coastal buffer (keep this global)
light_coastal <- raster::mask(light_200, coastal_buffer_sp)

# DON'T apply global threshold yet - keep all coastal light
light_sources_agg <- raster::aggregate(light_coastal, fact = 2, fun = mean)

# Convert ALL coastal sources to points (no threshold yet!)
light_source_df <- raster::rasterToPoints(light_sources_agg, spatial = FALSE) %>%
  as.data.frame()

colnames(light_source_df) <- c("x", "y", "light_intensity")

light_source_points <- light_source_df %>%
  st_as_sf(coords = c("x", "y"), crs = target_crs) %>%
  filter(!is.na(light_intensity) & light_intensity > 0)  # Remove NA and zeros only

# Normalize intensity (0-1 scale)
max_light <- max(light_source_points$light_intensity, na.rm = TRUE)
light_source_points$intensity_index <- light_source_points$light_intensity / max_light

cat("Total coastal light sources (no threshold):", nrow(light_source_points), "\n")
cat("Intensity range:", 
    round(min(light_source_points$intensity_index), 3), "-",
    round(max(light_source_points$intensity_index), 3), "\n")
```

## Setup Grid and Transition Layer

```{r setup-exposure}
# Create water-only grid (much faster than full study area grid)
water_polygon_sf <- raster::rasterToPolygons(water_mask, dissolve = TRUE) %>%
  st_as_sf()

grid_res <- 200
grid_water <- st_make_grid(water_polygon_sf,
                           cellsize = grid_res,
                           what = "centers") %>%
  st_sf() %>%
  st_intersection(water_polygon_sf)

# Create water-only transition layer
tr_water <- create_water_transition(bathy_200)

# Create template raster
template_raster <- create_template_raster(bathy_200)

```


```{r divition approach }
# ===============================================================================
# DIVIDE, THRESHOLD, CLUSTER - PRESERVE GLOBAL INTENSITY
# ===============================================================================

#sections <- list(
  #Lower = list(name = "Lower Saguenay", xmin = 345000, xmax = 385000),
  #Middle = list(name = "Middle Saguenay", xmin = 385000, xmax = 420000),
 # Upper = list(name = "Upper Saguenay", xmin = 420000, xmax = 450000)
#)

sections <- list(
  Section1 = list(name = "Section 1", xmin = 345000, xmax = 365000),
  Section2 = list(name = "Section 2", xmin = 365000, xmax = 385000),
  Section3 = list(name = "Section 3", xmin = 385000, xmax = 405000),
  Section4 = list(name = "Section 4", xmin = 405000, xmax = 425000),
  Section5 = list(name = "Section 5", xmin = 425000, xmax = 450000)
)

decay_type <- "III"

# *** CRITICAL: Calculate GLOBAL max intensity ONCE at the start ***
global_max_intensity <- max(light_source_points$light_intensity, na.rm = TRUE)
cat("Global max intensity:", round(global_max_intensity, 3), "\n")
cat("This will be used to maintain proportions across all sections\n\n")

section_exposures <- list()
section_summary <- list()

for (section_name in names(sections)) {
  
  cat("========================================\n")
  cat("SECTION:", sections[[section_name]]$name, "\n")
  cat("========================================\n")
  
  # Filter sources to this section
  sec_xmin <- sections[[section_name]]$xmin
  sec_xmax <- sections[[section_name]]$xmax
  
  light_section <- light_source_points %>%
    filter(st_coordinates(.)[,1] >= sec_xmin & 
           st_coordinates(.)[,1] < sec_xmax)
  
  cat("All sources in section:", nrow(light_section), "\n")
  
  if (nrow(light_section) == 0) {
    cat("No sources - skipping\n\n")
    next
  }
  
  # Apply 75th percentile threshold WITHIN section
  section_threshold <- quantile(light_section$light_intensity, 
                                probs = 0.75, na.rm = TRUE)
  
  light_section <- light_section %>%
    filter(light_intensity >= section_threshold)
  
  cat("After 75th percentile filter:", nrow(light_section), "sources\n")
  
  if (nrow(light_section) == 0) {
    cat("No sources above threshold - skipping\n\n")
    next
  }
  
  # *** CRITICAL: Use GLOBAL scale, not section scale ***
  light_section$intensity_index <- light_section$light_intensity / global_max_intensity
  
  cat("Intensity range in section (global scale):",
      round(min(light_section$intensity_index), 3), "-",
      round(max(light_section$intensity_index), 3), "\n")
  
  # Cluster within section
  coords_section <- st_coordinates(light_section)
  clusters_section <- dbscan(coords_section, eps = 500, minPts = 1)
  
  cat("Clusters in section:", max(clusters_section$cluster), "\n")
  
  # Aggregate clusters - sum intensities (preserves global scale!)
  light_section_clustered <- light_section %>%
    mutate(cluster = clusters_section$cluster) %>%
    group_by(cluster) %>%
    arrange(desc(intensity_index)) %>%
    mutate(
      total_intensity = sum(intensity_index),  # Sum on global scale
      n_sources = n()
    ) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(intensity_index = total_intensity)  # Keep global scale!
  
  # *** DON'T RENORMALIZE - keep global scale! ***
  # NO: light_section_clustered$intensity_index <- ... / max_int
  
  cat("Processing", nrow(light_section_clustered), "clusters\n")
  cat("Cluster intensity range (global scale):",
      round(min(light_section_clustered$intensity_index), 3), "-",
      round(max(light_section_clustered$intensity_index), 3), "\n")
  cat("Avg sources/cluster:", round(mean(light_section_clustered$n_sources), 1), "\n\n")
  
  # Process clusters with GLOBAL intensity weights
  cluster_exposures <- list()
  
  for (i in 1:nrow(light_section_clustered)) {
    cat("  Cluster", i, "/", nrow(light_section_clustered),
        "- Global Intensity:", round(light_section_clustered$intensity_index[i], 3),
        "- Sources:", light_section_clustered$n_sources[i], "\n")
    
    intensity <- light_section_clustered$intensity_index[i]  # Global scale weight
    
    single_exp <- RelativeExposure(
      source = light_section_clustered[i,],
      transition = tr_water,
      decay_type = decay_type,
      grid_points_sf = grid_water,
      empty_raster = template_raster
    )
    
    cluster_exposures[[i]] <- single_exp * intensity  # Weight by global intensity
  }
  
  # Combine this section
  section_exp <- Reduce('+', cluster_exposures)
  section_exposures[[section_name]] <- section_exp
  
  section_summary[[section_name]] <- list(
    n_sources = nrow(light_section),
    n_clusters = nrow(light_section_clustered),
    avg_per_cluster = mean(light_section_clustered$n_sources),
    max_intensity_global = max(light_section_clustered$intensity_index)
  )
  
  cat("Section", section_name, "complete!\n")
  cat("Max cluster intensity in this section (global scale):",
      round(section_summary[[section_name]]$max_intensity_global, 3), "\n\n")
}

# Combine all sections
cat("========================================\n")
cat("COMBINING ALL SECTIONS\n")
cat("========================================\n")

combined_exposure <- Reduce('+', section_exposures)

# Final normalization to 0-1 (only done once at the end)
max_val <- cellStats(combined_exposure, stat = "max", na.rm = TRUE)
combined_exposure <- combined_exposure / max_val

fjord_mask <- !is.na(bathy_200)
combined_exposure[fjord_mask & combined_exposure == 0] <- 0.0001
combined_exposure[!fjord_mask] <- NA

coastal_exp <- combined_exposure

# Summary
cat("\n=== SUMMARY (with global intensity preserved) ===\n")
for (sec in names(section_summary)) {
  cat(sec, ":\n")
  cat("  Clusters:", section_summary[[sec]]$n_clusters, 
      "from", section_summary[[sec]]$n_sources, "sources\n")
  cat("  Max intensity (global scale):", 
      round(section_summary[[sec]]$max_intensity_global, 3), "\n")
}
cat("\nTotal clusters:", sum(sapply(section_summary, function(x) x$n_clusters)), "\n")
cat("Final max exposure:", round(max_val, 6), "\n")
```


# Results Visualization

## Coastal Development Exposure

```{r plot-coastal-exposure, fig.cap="Coastal development exposure using binary nightlight classification with Level III decay"}
#png("coastal_development_6_sections_0.00001.png")
plot_exposure(coastal_exp,
              "Coastal Development Exposure -  6 sections approach (Level III)",
              xmin, xmax, ymin, ymax)
#dev.off()
```


# Save Results

```{r save-results}
# Save exposure raster
writeRaster(coastal_exp,
            filename = "coastal_development_exposure.tif",
            overwrite = TRUE)

# Save source points
st_write(light_source_points,
         "coastal_light_sources.gpkg",
         delete_dsn = TRUE)

# Save workspace
save(coastal_exp,
     light_source_points,
     coastal_buffer,
     file = "coastal_development_exposure.RData")
```


# References

Halpern, B. S., Walbridge, S., Selkoe, K. A., Kappel, C. V., Micheli, F., D'Agrosa, C., ... & Watson, R. (2008). A global map of human impact on marine ecosystems. *Science*, 319(5865), 948-952.

Knowledge Network for Bioinformatics. (2019). *Global nightlight raster data for marine impact assessment*. https://knb.ecoinformatics.org/view/doi:10.5063/F19Z92TW

Davies, T. W., Duffy, J. P., Bennie, J., & Gaston, K. J. (2014). The nature, extent, and ecological implications of marine light pollution. *Frontiers in Ecology and the Environment*, 12(6), 347-355.

Navara, K. J., & Nelson, R. J. (2007). The dark side of light at night: physiological, epidemiological, and ecological consequences. *Journal of Pineal Research*, 43(3), 215-224.

---

**Session Info:**
```{r session-info}
sessionInfo()
```