---
title: "Shipping Traffic Exposure in the Saguenay Fjord"
author: "Hediyeh Yazdanpanah"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    highlight: pygments
    theme: yeti
    toc: TRUE
    toc_depth: 4
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
    df_print: paged
    fig_caption: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = TRUE,
  message = TRUE,
  error = TRUE,
  fig.width = 10,
  fig.height = 8
)

# SET WORKING DIRECTORY
knitr::opts_knit$set(root.dir = ".")

# Source shared functions
# Source shared functions (this will load all required packages)
#source("/Users/hediyeh/Desktop/Phd_project_analyses/Chapter_1/00_shared_functions.R")
source("../../00_shared_functions_0.00025.R")

# Load extra packages
library(RColorBrewer)

```

# Introduction

Maritime traffic represents a significant environmental stressor in the Saguenay Fjord through multiple pathways including physical disturbance from vessel wakes, underwater noise pollution, chemical contamination, and habitat fragmentation. This analysis quantifies shipping exposure across the fjord using Automatic Identification System (AIS) satellite data.

## Data Sources

Navigation intensity was assessed using **AIS satellite data** formatted by Maerospace Corporation and acquired for the Canadian Space Agency (Canada, 2020a, 2020b). The data spans 2017-2019 and includes all vessel movements within the study area.

## Vessel Categories

The analysis encompasses **11 distinct vessel categories**:

1. **Cargo vessels** - General cargo ships
2. **Dry bulk carriers** - Bulk commodity transport
3. **Tanker vessels** - Oil and chemical tankers
4. **Container ships** - Containerized cargo
5. **Passenger ferries and RO-RO vessels** - Ferry services
6. **Pleasure craft** - Recreational vessels
7. **Tugs and port service vessels** - Harbor operations
8. **Government and research vessels** - Official operations
9. **Special purpose ships** - Specialized vessels
10. **Marine mammal observation vessels** - Whale watching operations
11. **Port navigation activities** - Port zone traffic (53,386 transits recorded)

## Methodology Overview

1. **Data Processing**: Individual AIS locations transformed into linear navigation segments
2. **Corridor Identification**: Main shipping corridors identified using 75th percentile threshold
3. **Vessel-Specific Exposure**: Individual exposure fields calculated for each vessel category
4. **Combined Assessment**: Weighted integration of all vessel type exposures
5. **Spatial Decay Modeling**: Level III decay function for medium-range shipping effects

# Data Loading

## Base Data

```{r load-base-data}
# Check if bathy.tif exists
if(!file.exists("bathy.tif")) {
  bathy_path <- "../bathy.tif"
  if(!file.exists(bathy_path)) {
    stop("bathy.tif not found. Please check file location.")
  }
} else {
  bathy_path <- "bathy.tif"
}

# Load bathymetry and create water mask
bathy_data <- load_bathymetry(bathy_path = bathy_path)
bathy_200 <- bathy_data$bathy_200
water_mask <- bathy_data$water_mask
water_sf <- bathy_data$water_sf
```

## Navigation Data

```{r load-navigation-data}
# Load gridded navigation data
navigation <- st_read("st_navigation.geojson", quiet = TRUE)

# Transform to UTM and crop to study area
navigation_utm <- st_transform(navigation, crs = target_crs)

saguenay_bbox <- st_bbox(c(xmin = xmin, ymin = ymin, 
                           xmax = xmax, ymax = ymax),
                         crs = st_crs(target_crs)) %>%
  st_as_sfc()

navigation_saguenay <- st_crop(navigation_utm, saguenay_bbox)

cat("Total navigation grid cells:", nrow(navigation_saguenay), "\n")
```

# Main Shipping Corridor Identification

## Vessel Type Definition

```{r define-vessel-types}
# Define vessel categories and their column names in the data
vessel_types <- list(
  CARGO = "CARGO",
  DRY_BULK = "DRY.BULK",
  TANKER = "TANKER",
  CONTAINER = "CONTAINER",
  PASSENGER_FERRY = "PASSENGER.FERRY.RO.RO",
  PLEASURE_VESSELS = "PLEASURE.VESSELS",
  TUGS_PORT = "TUGS.PORT",
  GOVERNMENT_RESEARCH = "GOVERNMENT.RESEARCH",
  SPECIAL_SHIPS = "SPECIAL.SHIPS",
  PORT = "navigation_portuaire",
  MARINE_MAMMAL = "Observation"
)
```

## Corridor Identification Method

Main shipping corridors are identified using a **percentile-based threshold approach**. For each vessel category, areas representing the **top 25% of navigation activity** (75th percentile) are selected. This ensures exposure calculations focus on high-traffic corridors rather than sporadic movements.

```{r identify-corridors}
# Function to identify main corridors for each vessel type
identify_shipping_corridors <- function(data, vessel_column, 
                                       percentile_threshold = 0.75) {
  
  # Get vessel activity data
  vessel_data <- data[!is.na(data[[vessel_column]]), ]
  vessel_values <- vessel_data[[vessel_column]]
  vessel_values <- vessel_values[vessel_values > 0]
  
  if (length(vessel_values) == 0) {
    return(NULL)
  }
  
  # Calculate threshold for main corridors
  threshold <- quantile(vessel_values, percentile_threshold, na.rm = TRUE)
  
  # Filter to main corridors and convert to point sources
  corridors <- vessel_data %>%
    filter(.data[[vessel_column]] >= threshold) %>%
    mutate(intensity_index = .data[[vessel_column]]) %>%
    st_centroid()
  
  cat(vessel_column, "- Corridors:", nrow(corridors), 
      "| Threshold:", round(threshold, 2), "\n")
  
  return(corridors)
}

# Apply 75th percentile threshold to all vessel types
percentile_threshold <- 0.75

shipping_corridors <- list()

for (vessel_name in names(vessel_types)) {
  vessel_col <- vessel_types[[vessel_name]]
  
  corridors <- identify_shipping_corridors(
    navigation_saguenay, 
    vessel_col, 
    percentile_threshold
  )
  
  if (!is.null(corridors) && nrow(corridors) > 0) {
    shipping_corridors[[vessel_name]] <- corridors
  }
}

cat("\nMain shipping corridors identified for", 
    length(shipping_corridors), "vessel types\n")
```

```{r corridor-summary-table}
# Create summary table of corridor counts
corridor_summary <- data.frame(
  Vessel_Type = names(shipping_corridors),
  Corridor_Count = sapply(shipping_corridors, nrow),
  Total_Intensity = sapply(shipping_corridors, function(x) 
    sum(x$intensity_index, na.rm = TRUE))
)

knitr::kable(
  corridor_summary %>% arrange(desc(Corridor_Count)),
  caption = "Main Shipping Corridors by Vessel Type (75th Percentile)",
  digits = 0,
  col.names = c("Vessel Type", "Corridor Sources", "Total Intensity")
)
```

# Exposure Calculation

## Setup Grid and Transition Layer

```{r setup-exposure}
# Create grid system
grid_system <- create_grid_system(xmin, ymin, xmax, ymax, grid_res = 200)
grid_points_sf <- grid_system$grid_points_sf
grid_polygons_sf <- grid_system$grid_polygons_sf

# Create shipping-specific transition layer
# High conductance in water, blocked by land
tr_shipping <- create_shipping_transition(bathy_200)

# Create template raster
template_raster <- create_template_raster(bathy_200)
```

## Calculate Vessel-Specific Exposures

```{r calculate-vessel-exposures}
# Set decay type for shipping (medium-range effects)
decay_type <- "III"

# Calculate exposure for each vessel type
vessel_exposures <- list()

cat("Calculating individual vessel type exposures...\n\n")

for (vessel_name in names(shipping_corridors)) {
  
  cat("Processing", vessel_name, "...\n")
  
  corridors <- shipping_corridors[[vessel_name]]
  
  # Calculate exposure for this vessel type
  vessel_exp <- RelativeExposure(
    source = corridors,
    transition = tr_shipping,
    decay_type = decay_type,
    grid_points_sf = grid_points_sf,
    empty_raster = template_raster
  )
  
  # Apply water mask
  vessel_exp <- mask(vessel_exp, water_mask < 0)
  
  # Store result
  vessel_exposures[[vessel_name]] <- vessel_exp
  
  cat(vessel_name, "exposure calculated\n\n")
}
```

## Intensity-Weighted Integration

```{r combine-exposures}
# Calculate total intensity for each vessel type
vessel_total_intensity <- sapply(shipping_corridors, function(x) 
  sum(x$intensity_index, na.rm = TRUE))

# Calculate overall total intensity
total_shipping_intensity <- sum(vessel_total_intensity, na.rm = TRUE)

# Calculate weight for each vessel type
vessel_weights <- vessel_total_intensity / total_shipping_intensity

# Display vessel type contributions
cat("=== VESSEL TYPE INTENSITY CONTRIBUTIONS ===\n")
for (vessel_name in names(vessel_weights)) {
  cat(sprintf("%-20s: %5.2f%%\n", vessel_name, 
              vessel_weights[vessel_name] * 100))
}

# Combine all vessel exposures with weighting
combined_exposure <- template_raster
combined_exposure[] <- 0

for (vessel_name in names(vessel_exposures)) {
  vessel_raster <- vessel_exposures[[vessel_name]]
  weight <- vessel_weights[[vessel_name]]
  
  # Weight this vessel type's exposure
  weighted_raster <- vessel_raster * weight
  weighted_raster[is.na(weighted_raster)] <- 0
  
  # Add to combined exposure
  combined_exposure <- combined_exposure + weighted_raster
}

# Apply water mask and normalize
combined_exposure <- mask(combined_exposure, water_mask < 0)

max_combined <- cellStats(combined_exposure, stat = "max", na.rm = TRUE)
if (!is.na(max_combined) && max_combined > 0) {
  shipping_exp <- combined_exposure / max_combined
} else {
  shipping_exp <- combined_exposure
}

# Set 0 values to NA
shipping_exp[shipping_exp == 0] <- NA
```

```{r exposure-stats}
cat("\n=== SHIPPING EXPOSURE STATISTICS ===\n")
cat("Total vessel types processed:", length(vessel_exposures), "\n")
cat("Total corridor sources:", sum(sapply(shipping_corridors, nrow)), "\n")
cat("Max combined exposure:", round(max_combined, 6), "\n")
cat("Mean exposure:", 
    round(cellStats(shipping_exp, "mean", na.rm=TRUE), 6), "\n")
cat("Non-NA cells:", sum(!is.na(values(shipping_exp))), "\n")
```

# Results Visualization

## Combined Shipping Exposure

```{r plot-combined-exposure, fig.cap="Combined shipping exposure from all vessel types using Level III decay"}
plot_exposure(shipping_exp,
              "Shipping Traffic Exposure - All Vessel Types (Level III)",
              xmin, xmax, ymin, ymax)
```

## Individual Vessel Type Exposures

```{r plot-individual-vessels, fig.width=12, fig.height=10, fig.cap="Individual vessel type exposure patterns"}
# Calculate optimal grid layout
n_vessels <- length(vessel_exposures)

if (n_vessels <= 4) {
  nrows <- 2; ncols <- 2
} else if (n_vessels <= 6) {
  nrows <- 2; ncols <- 3
} else if (n_vessels <= 9) {
  nrows <- 3; ncols <- 3
} else {
  nrows <- ceiling(sqrt(n_vessels))
  ncols <- ceiling(n_vessels / nrows)
}

# Create multi-panel plot
par(mfrow = c(nrows, ncols), mar = c(2, 2, 2, 1))

for (vessel_name in names(vessel_exposures)) {
  plot(vessel_exposures[[vessel_name]],
       main = vessel_name,
       axes = TRUE,
       cex.main = 0.8,
       legend = FALSE,
       xlim = c(xmin, xmax),
       ylim = c(ymin, ymax))
}

par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1)
```

## Shipping Corridors Overlay

```{r plot-corridors, fig.cap="Main shipping corridors overlaid on combined exposure"}
# Sort vessels by corridor count for better visualization
corridor_counts <- sapply(shipping_corridors, nrow)
sorted_vessels <- names(sort(corridor_counts))

# Create color palette
colors <- rainbow(length(shipping_corridors))
names(colors) <- names(shipping_corridors)

# Plot with extra margin for legend
par(mar = c(5, 4, 4, 8), xpd = FALSE)

plot(shipping_exp,
     main = "Main Shipping Corridors and Combined Exposure",
     xlab = "Easting (UTM Zone 19N)",
     ylab = "Northing (UTM Zone 19N)",
     axes = TRUE)

# Add corridor points
for (vessel_name in sorted_vessels) {
  corridors <- shipping_corridors[[vessel_name]]
  points(corridors, pch = 16, cex = 0.4, col = colors[vessel_name])
}

# Add legend outside plot
par(xpd = TRUE)
legend(x = par("usr")[2] * 1.02,
       y = par("usr")[4],
       legend = names(shipping_corridors),
       col = colors,
       pch = 16,
       cex = 0.65,
       bg = "white",
       xjust = 0)

par(xpd = FALSE, mar = c(5, 4, 4, 2) + 0.1)
```

# Save Results

```{r save-results}
# Save combined exposure
writeRaster(shipping_exp,
            filename = "shipping_exposure.tif",
            overwrite = TRUE)

# Save individual vessel exposures
for (vessel_name in names(vessel_exposures)) {
  filename <- paste0("shipping_exposure_", vessel_name, ".tif")
  writeRaster(vessel_exposures[[vessel_name]], 
              filename, 
              overwrite = TRUE)
}

# Save workspace
save(shipping_exp,
     vessel_exposures,
     shipping_corridors,
     vessel_weights,
     file = "shipping_exposure.RData")
```

# Summary

This shipping exposure analysis successfully developed a comprehensive model to quantify maritime traffic impacts on the Saguenay Fjord ecosystem:

**Key Features:**
- **Multi-Category Assessment**: Individual analysis of 11 vessel categories
- **Corridor-Based Approach**: Focus on high-traffic areas (75th percentile threshold)
- **Intensity-Weighted Integration**: Vessel types weighted by total traffic intensity
- **Specialized Transition Function**: Shipping effects propagate through water but blocked by land
- **Level III decay** function applied for medium-range shipping effects

**Results:**
- **`r length(shipping_corridors)`** vessel types with identified main corridors
- **`r sum(sapply(shipping_corridors, nrow))`** total corridor source points
- **Dominant contributor**: `r names(vessel_weights)[which.max(vessel_weights)]` 
  (`r round(max(vessel_weights) * 100, 1)`% of total intensity)

**Main Shipping Corridors:**
The analysis reveals distinct spatial patterns for different vessel types, with cargo vessels, tankers, and passenger ferries showing the highest traffic intensities in the main navigation channel, while recreational and whale-watching activities concentrate in different areas of the fjord.

**Environmental Implications:**
The spatial distribution of shipping exposure highlights areas where benthic communities experience cumulative impacts from:
- Underwater noise pollution affecting marine mammals and fish
- Physical disturbance from vessel wakes
- Chemical contamination from fuel and ballast water
- Potential sediment resuspension in high-traffic areas

# References

Canada. (2020a). *AIS satellite data acquisition program*. Canadian Space Agency.

Canada. (2020b). *Maritime domain awareness through satellite AIS*. Canadian Space Agency.

Ministère de l'Économie et de l'Innovation. (2021). *Industrial-port zones of Quebec*. Government of Quebec.

Ministère des Transports du Québec. (2021). *Port facilities database*. Government of Quebec.

Turgeon, S. (2019). *Marine mammal observation vessel activity in the Saguenay-St. Lawrence Marine Park, 2017*. Parks Canada.

Erbe, C., Reichmuth, C., Cunningham, K., Lucke, K., & Dooling, R. (2016). Communication masking in marine mammals: A review and research strategy. *Marine Pollution Bulletin*, 103(1-2), 15-38.

---

**Session Info:**
```{r session-info}
sessionInfo()
```