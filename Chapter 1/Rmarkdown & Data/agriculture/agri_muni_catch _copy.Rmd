---
title: "agri_muni_catch"
author: "Hediyeh"
date: "2025-06-10"
output: html_document
---

```{r diagnostic, echo=TRUE}
# Check working directory and files
cat("Working directory:", getwd(), "\n")
cat("Files in directory:\n")
print(list.files(pattern = "\\.(gpkg|shp|xlsx|tif)$"))

# Check each file specifically
files_needed <- c("corrected_watersheds.gpkg", "munic_s.shp", "SF_agri_all.xlsx", "bathy.tif")
for(file in files_needed) {
  cat(file, "exists:", file.exists(file), "\n")
}
```

## Agricultural Activities in Saguenay Fjord catchment basin

### Economic Significance

Agriculture in the Saguenay region represents a significant economic sector, generating **2,400 jobs** and **gross sales exceeding $270 million** as of 2010. This economic activity is concentrated within the catchment basin area that ultimately drains into the Saguenay Fjord, making agricultural runoff a relevant stressor for marine ecosystem assessment.

### Spatial Distribution and Land Use

The agricultural zone within the Saguenay catchment basin covers **1,554.06 km²**, with **598 registered agricultural enterprises**. These operations are predominantly located in the **western portion of the Saguenay River lowlands**, often in close proximity to waterways and tributaries that connect directly to the fjord system.

**Key municipalities** dominating agricultural land use include:
- **Saguenay City**
- Alma City 
- Saint-David-de-Falardeau Municipality

Together, these three jurisdictions account for **54.50% of all cultivated land** in the catchment basin, representing the primary source areas for agricultural runoff entering the fjord system.

### Agricultural Production Types

#### Crop Production
**Cereal and forage production** represent the largest agricultural land uses:
- **Cereals**: 340 enterprises cultivating **18,869 hectares**
- **Forage crops**: 414 enterprises cultivating **26,297 hectares**

#### Specialty Crops
The region also supports significant **specialty crop production**:
- **Wild blueberries**: 57 enterprises cultivating **9,800 hectares**
- **Potatoes**: 32 enterprises cultivating **1,992 hectares** (table and seed markets)

### Implications for Fjord Impact Assessment

The spatial concentration of agricultural activities in **western lowland areas** near waterways creates focused **runoff pathways** that channel agricultural contaminants toward the fjord system. The dominance of **dairy operations** and **intensive crop production** suggests potential inputs of **nutrients** (nitrogen and phosphorus), **pesticides**, and **organic matter** that could influence fjord water quality and benthic community structure.

The **proximity of agricultural operations to waterways** combined with the **concentrated spatial distribution** makes agricultural runoff a priority stressor for cumulative impact assessment in the Saguenay Fjord ecosystem.

For more detailed information about agricultural activities in the Saguenay watershed, see the complete report [link](https://www.obvsaguenay.org/wp-content/uploads/2020/09/pdesaguenay2015doc06-0_portraitchap4_obvs2015.pdf#page=3.11).

we don't have enough data report for the pesticides and fertilizers, hence we consider **cultivated area** as a proxy for the agriculture activities. 

## Catchment Basin Importance for Saguenay Fjord Impact Assessment

### Watershed-Marine Connectivity

The **catchment basin** (or watershed) represents the fundamental spatial unit for understanding how **terrestrial human activities** influence aquatic ecosystems in the Saguenay Fjord. A catchment basin encompasses all land areas that drain surface water and groundwater to a common outlet - in this case, the Saguenay Fjord system. This hydrological connectivity means that **all activities occurring within the watershed** have the potential to affect **downstream marine environments** through various transport pathways.

### Terrestrial-Marine Linkages

**Agricultural activities** within the Saguenay catchment basin directly influence fjord ecosystem health through multiple pathways:

**Hydrological Transport**: Surface runoff and subsurface flow transport **nutrients, sediments, pesticides, and organic matter** from terrestrial sources to the fjord system. The **intensity and timing** of these inputs depend on land use patterns, management practices, and precipitation events throughout the entire watershed.

**Cumulative Effects**:  agricultural fields may appear to have minimal local impact, but when considered across the **entire catchment basin**, these activities collectively create **significant cumulative pressures** on the receiving marine environment.

**Spatial Connectivity**: The **hierarchical nature** of watershed systems means that impacts from **upstream activities** can propagate downstream, potentially affecting areas far removed from the original disturbance source. Understanding this connectivity is essential for identifying the true spatial extent of terrestrial influences on fjord ecosystems.

### Assessment Rationale

Analyzing agriculture activities at the **catchment basin scale** is crucial because:

- **Complete impact assessment** requires accounting for all potential source areas, not just immediate coastal zones
- **Pollutant loading** to the fjord represents the **integrated effect** of land use across the entire watershed
- **Management strategies** must address terrestrial activities at appropriate **watershed scales** to effectively protect marine ecosystems
- **Cumulative impact modeling** requires understanding the **full spatial domain** of human activities that influence the receiving water body

This watershed-scale approach ensures that the assessment captures the **complete range of terrestrial influences** on Saguenay Fjord ecosystem health, providing a comprehensive foundation for **ecosystem-based management** strategies.

## References

Allan, J. D. (2004). Landscapes and riverscapes: the influence of land use on stream ecosystems. *Annual Review of Ecology, Evolution, and Systematics*, 35, 257-284.

```{r setup1, include=FALSE}
library(here)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Overview

This analysis quantifies agricultural exposure from river watersheds draining into the Saguenay Fjord using cultivated areas within each watershed and cost-distance decay functions.

## 1. Load Required Libraries and Prepare Data
we have data for cultivated area in each municipalities, first load data :

```{r setup, include=FALSE}

# library needed
library(terra)
library(sf)
library(gdistance)
library(dplyr)
library(raster)
library(ggplot2)
library(gstat)
library(viridis)
library(RColorBrewer)
library(scales)
library(grid)
library(readxl)
library(jsonlite)
```

```{r libraries-and-data}
# Load required libraries
library(sf)
library(raster)
library(dplyr)
library(gdistance)
library(readxl)
library(RColorBrewer)

# Define coordinate reference system
target_crs <- "+proj=utm +zone=19 +datum=WGS84 +units=m +no_defs"

# Load watersheds
watersheds <- st_read("corrected_watersheds.gpkg")
watersheds <- st_transform(watersheds, crs = target_crs)

# Load municipalities
agriculture_munic <- st_read("munic_s.shp")

# Select municipalities
munic_all_select <- c("L'Anse-Saint-Jean", "Petit-Saguenay", "Rivière-Éternité", 
                     "Saguenay", "Saint-Félix-d'Otis", "Saint-Fulgence", 
                     "Sacré-Coeur", "Sainte-Rose-du-Nord", "Ferland-et-Boilleau", "Alma",
                     "Baie-Sainte-Catherine", "Bégin", "Ferland-et-Boilleau", "Hébertville", 
                     "Héberville-Station", "L'Ascension-de-Notre-Seigneur", "Labrecque", "Lamarche", 
                     "Larouche", "Saint-Ambroise", "Saint-Bruno", "Saint-Charles-de-Bourget",
                     "Saint-David-de-Falardeau", "Saint-Gédéon", "Saint-Honoré", "Saint-Nazaire", 
                     "Saint-Siméon", "Tadoussac")

# Filter and prepare municipality data
munic_all_SF <- agriculture_munic %>%
  filter(MUS_NM_MUN %in% munic_all_select) %>%
  select(municipalite = MUS_NM_MUN, geometry)

munic_all_SF <- st_transform(munic_all_SF, crs = target_crs)

# Load agriculture data
agri_all_SF <- read_excel("SF_agri_all.xlsx")

# Merge data
data_agri_sf_all <- left_join(munic_all_SF, agri_all_SF, by = "municipalite")
data_agri_sf_all <- st_transform(data_agri_sf_all, crs = target_crs)
```

## 2. Calculate Cultivated Area per Watershed

### Initial Intersection Calculation

```{r initial-intersections}
# Calculate municipality-watershed intersections
intersections <- st_intersection(data_agri_sf_all, watersheds)

# Add municipality total areas
for(i in 1:nrow(intersections)) {
  muni_name <- intersections$municipalite[i]
  total_area <- as.numeric(st_area(data_agri_sf_all[data_agri_sf_all$municipalite == muni_name, ])) / 10000
  intersections$total_area_ha[i] <- total_area
}

# Calculate intersection areas
intersections$intersection_area_ha <- as.numeric(st_area(intersections)) / 10000

# Calculate municipality proportions
intersections$municipality_proportion <- ifelse(
  intersections$total_area_ha > 0,
  intersections$intersection_area_ha / intersections$total_area_ha,
  0
)

# Calculate cultivated area per intersection
cultivated_col_name <- "Estimated.cultivated.area.in.the.zone"
cultivated_area_result <- rep(0, nrow(intersections))

for(i in 1:nrow(intersections)) {
  prop_val <- intersections$municipality_proportion[i]
  cult_val <- intersections[[cultivated_col_name]][i]
  
  if(length(prop_val) > 0 && length(cult_val) > 0 &&
     !is.na(prop_val) && !is.na(cult_val)) {
    cultivated_area_result[i] <- prop_val * cult_val
  } else {
    cultivated_area_result[i] <- 0
  }
}

intersections$cultivated_area_watershed_ha <- cultivated_area_result

# Sum cultivated area by watershed
watershed_agriculture <- intersections %>%
  st_drop_geometry() %>%
  group_by(RIVER_NAME) %>%
  summarise(
    total_cultivated_area_ha = sum(cultivated_area_watershed_ha, na.rm = TRUE),
    num_municipalities = n(),
    municipalities = paste(unique(municipalite), collapse = ", "),
    total_intersection_area_ha = sum(intersection_area_ha, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(total_cultivated_area_ha))

# Calculate relative contributions
watershed_agriculture$relative_contribution <-
  watershed_agriculture$total_cultivated_area_ha /
  sum(watershed_agriculture$total_cultivated_area_ha, na.rm = TRUE)

# Merge back with watershed spatial data
watersheds_with_agriculture <- watersheds %>%
  left_join(watershed_agriculture, by = "RIVER_NAME")

watersheds_with_agriculture$total_cultivated_area_ha[is.na(watersheds_with_agriculture$total_cultivated_area_ha)] <- 0
watersheds_with_agriculture$relative_contribution[is.na(watersheds_with_agriculture$relative_contribution)] <- 0
```

### Fix Duplicate Municipalities and Recalculate

```{r fix-duplicates}
# Clean duplicate municipalities by combining geometries and summing cultivated areas
cultivated_col_correct <- "Estimated cultivated area in the zone"

data_agri_sf_clean <- data_agri_sf_all %>%
  group_by(municipalite) %>%
  summarise(
    cultivated_area_total = sum(.data[[cultivated_col_correct]], na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  st_make_valid()

# Rename column for consistency
colnames(data_agri_sf_clean)[colnames(data_agri_sf_clean) == "cultivated_area_total"] <- 
  "Estimated.cultivated.area.in.the.zone"

# Recalculate intersections with cleaned data
watersheds_clean <- st_make_valid(st_transform(watersheds, crs = target_crs))
data_agri_sf_clean <- st_make_valid(st_transform(data_agri_sf_clean, crs = target_crs))

intersections_fixed <- st_intersection(data_agri_sf_clean, watersheds_clean)

# Recalculate areas
intersections_fixed$total_area_ha <- NA
intersections_fixed$intersection_area_ha <- as.numeric(st_area(intersections_fixed)) / 10000

for(i in 1:nrow(intersections_fixed)) {
  muni_name <- intersections_fixed$municipalite[i]
  muni_row <- data_agri_sf_clean[data_agri_sf_clean$municipalite == muni_name, ]
  if(nrow(muni_row) > 0) {
    total_area <- as.numeric(st_area(muni_row)) / 10000
    intersections_fixed$total_area_ha[i] <- total_area
  }
}

# Recalculate proportions
intersections_fixed$municipality_proportion <- ifelse(
  intersections_fixed$total_area_ha > 0,
  intersections_fixed$intersection_area_ha / intersections_fixed$total_area_ha,
  0
)

# Recalculate cultivated area contributions
intersections_fixed$cultivated_area_watershed_ha <-
  intersections_fixed$municipality_proportion *
  intersections_fixed$`Estimated.cultivated.area.in.the.zone`

# Recalculate watershed totals (CORRECTED)
watershed_agriculture_fixed <- intersections_fixed %>%
  st_drop_geometry() %>%
  group_by(RIVER_NAME) %>%
  summarise(
    total_cultivated_area_ha = sum(cultivated_area_watershed_ha, na.rm = TRUE),
    num_municipalities = n(),
    municipalities = paste(unique(municipalite), collapse = ", "),
    total_intersection_area_ha = sum(intersection_area_ha, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(total_cultivated_area_ha))

# Calculate relative contributions
total_all_cultivated <- sum(watershed_agriculture_fixed$total_cultivated_area_ha, na.rm = TRUE)
watershed_agriculture_fixed$relative_contribution <-
  watershed_agriculture_fixed$total_cultivated_area_ha / total_all_cultivated

# Merge back with watershed spatial data
watersheds_with_agriculture_fixed <- watersheds %>%
  left_join(watershed_agriculture_fixed, by = "RIVER_NAME")

watersheds_with_agriculture_fixed$total_cultivated_area_ha[is.na(watersheds_with_agriculture_fixed$total_cultivated_area_ha)] <- 0
watersheds_with_agriculture_fixed$relative_contribution[is.na(watersheds_with_agriculture_fixed$relative_contribution)] <- 0
```
```{r intensity index}
### Calculate Intensity Index Based on Proportion Cultivated
# Add watershed areas and calculate intensity index
watershed_agriculture_fixed <- watershed_agriculture_fixed %>%
  mutate(
    watershed_area_ha = NA,
    proportion_cultivated = NA,
    intensity_index = NA
  )

# Calculate watershed areas and proportions
for(i in 1:nrow(watershed_agriculture_fixed)) {
  river_name <- watershed_agriculture_fixed$RIVER_NAME[i]
  watershed_row <- watersheds[watersheds$RIVER_NAME == river_name, ]
  
  if(nrow(watershed_row) > 0) {
    total_area <- as.numeric(st_area(watershed_row)) / 10000
    watershed_agriculture_fixed$watershed_area_ha[i] <- total_area
    
    # Calculate proportion (percentage)
    watershed_agriculture_fixed$proportion_cultivated[i] <- 
      (watershed_agriculture_fixed$total_cultivated_area_ha[i] / total_area) * 100
  }
}

# Create normalized intensity index (0-1)
max_proportion <- max(watershed_agriculture_fixed$proportion_cultivated, na.rm = TRUE)
watershed_agriculture_fixed$intensity_index <- 
  watershed_agriculture_fixed$proportion_cultivated / max_proportion

# Display results
print("Watershed Agriculture Intensity Index:")
print(watershed_agriculture_fixed %>% 
  select(RIVER_NAME, total_cultivated_area_ha, watershed_area_ha, 
         proportion_cultivated, intensity_index) %>%
  arrange(desc(intensity_index)))

```

## 3. Identify River Mouth Locations

```{r bathymetry-and-river-mouths}
# Load bathymetry data
bathy <- raster("bathy.tif")
bathy_utm <- projectRaster(bathy, crs = target_crs)

# Define Saguenay Fjord extent
xmin <- 345000
ymin <- 5325000
xmax <- 450000
ymax <- 5370000
saguenay_extent <- extent(xmin, xmax, ymin, ymax)

# Crop and prepare bathymetry
bathy_proj <- crop(bathy_utm, saguenay_extent)
bathy_200 <- projectRaster(bathy_proj, crs = target_crs, res = c(200, 200))
bathy_200[bathy_200 > 0] <- 0

# Create water mask
water_mask <- bathy_200
water_mask[water_mask < 0] <- -1  # Water
water_mask[water_mask >= 0] <- 0  # Land

# Convert to polygons
bathy_poly <- rasterToPolygons(water_mask, dissolve = TRUE,
                               fun = function(x) x == -1)
water_sf <- st_as_sf(bathy_poly)
water_sf <- st_transform(water_sf, crs = target_crs)

# Function to find river mouths
find_exact_river_mouths <- function(watersheds, water_areas) {
  if (!identical(st_crs(watersheds), st_crs(water_areas))) {
    water_areas <- st_transform(water_areas, st_crs(watersheds))
  }
  
  river_mouths_list <- list()
  
  for (i in 1:nrow(watersheds)) {
    watershed <- watersheds[i, ]
    river_name <- watershed$RIVER_NAME
    
    watershed <- st_make_valid(watershed)
    water_areas <- st_make_valid(water_areas)
    
    tryCatch({
      watershed_boundary <- st_boundary(watershed)
      boundary_points <- st_cast(watershed_boundary, "POINT")
      
      distances_to_water <- st_distance(boundary_points, water_areas)
      
      min_distance_idx <- which.min(distances_to_water)
      closest_boundary_point <- boundary_points[min_distance_idx, ]
      
      water_boundary <- st_boundary(water_areas)
      nearest_water_points <- st_nearest_points(closest_boundary_point, water_boundary)
      water_point <- st_cast(nearest_water_points, "POINT")[2]
      
      water_centroid <- st_centroid(water_areas)
      direction <- st_coordinates(water_centroid) - st_coordinates(water_point)
      direction_length <- sqrt(sum(direction^2))
      
      if (direction_length > 0) {
        direction_norm <- direction / direction_length * 50
        new_coords <- st_coordinates(water_point) + direction_norm
        final_point <- st_sfc(st_point(new_coords), crs = st_crs(water_point))
      } else {
        final_point <- water_point
      }
      
      river_mouth <- st_sf(
        RIVER_NAME = river_name,
        geometry = final_point
      )
      
      river_mouths_list[[i]] <- river_mouth
      
    }, error = function(e) {
      watershed_center <- st_centroid(watershed)
      water_boundary <- st_boundary(water_areas)
      nearest_water <- st_nearest_points(watershed_center, water_boundary)
      fallback_point <- st_cast(nearest_water, "POINT")[2]
      
      river_mouth <- st_sf(
        RIVER_NAME = river_name,
        geometry = fallback_point
      )
      river_mouths_list[[i]] <- river_mouth
    })
  }
  
  do.call(rbind, river_mouths_list)
}

# Find river mouth locations
river_mouths_sf <- find_exact_river_mouths(watersheds, water_sf)
river_mouths_sf <- st_transform(river_mouths_sf, crs = target_crs)

# Enhanced function to correct river mouth positions
project_to_water_enhanced <- function(points, water_areas) {
  water_points_corrected <- list()
  
  for (i in 1:nrow(points)) {
    point <- points[i, ]
    river_name <- point$RIVER_NAME
    
    intersection <- st_intersection(point, water_areas)
    
    if (nrow(intersection) > 0) {
      water_points_corrected[[i]] <- point
    } else {
      water_boundary <- st_boundary(water_areas)
      nearest_points <- st_nearest_points(point, water_boundary)
      water_edge_point <- st_cast(nearest_points, "POINT")[2]
      
      water_centroid <- st_centroid(water_areas)
      direction <- st_coordinates(water_centroid) - st_coordinates(water_edge_point)
      direction_length <- sqrt(sum(direction^2))
      
      if (direction_length > 0) {
        direction_norm <- direction / direction_length * 100
        corrected_coords <- st_coordinates(water_edge_point) + direction_norm
        corrected_point <- st_sfc(st_point(corrected_coords), crs = st_crs(point))
      } else {
        corrected_point <- water_edge_point
      }
      
      water_point <- st_sf(
        RIVER_NAME = river_name,
        geometry = corrected_point
      )
      
      water_points_corrected[[i]] <- water_point
    }
  }
  
  do.call(rbind, water_points_corrected)
}

# Apply position correction
river_mouths_sf <- project_to_water_enhanced(river_mouths_sf, water_sf)

# Add agriculture data to river mouths (using CORRECTED data)
river_mouth_sf <- river_mouths_sf %>%
  left_join(
    watersheds_with_agriculture_fixed %>% st_drop_geometry() %>%
    select(RIVER_NAME, total_cultivated_area_ha, relative_contribution, municipalities),
    by = "RIVER_NAME"
  )
```


#river mouth and catchment basin
```{r river mouth and catchmentbasin}
# Create diagnostic plot showing river mouths and watersheds
n_rivers <- nrow(river_mouths_sf)
river_colors <- rainbow(n_rivers, alpha = 0.7)
names(river_colors) <- river_mouths_sf$RIVER_NAME

# Create the main plot
plot(st_geometry(water_sf),
     col = "lightblue",
     border = "blue",
     main = "River Mouth Locations and Watershed Boundaries",
     xlab = "Easting (UTM Zone 19N)", 
     ylab = "Northing (UTM Zone 19N)",
     xlim = c(xmin, xmax),
     ylim = c(ymin, ymax))

# Add watersheds with different colors
plot(st_geometry(watersheds),
     add = TRUE,
     col = adjustcolor(river_colors[watersheds$RIVER_NAME], alpha = 0.3),
     border = river_colors[watersheds$RIVER_NAME], 
     lwd = 1.5)

# Add river mouth points
points(st_coordinates(river_mouths_sf)[,1],
       st_coordinates(river_mouths_sf)[,2],
       pch = 21,
       cex = 2,
       bg = river_colors[river_mouths_sf$RIVER_NAME],
       col = "black",
       lwd = 2)

# Add river mouth labels
text(st_coordinates(river_mouths_sf)[,1],
     st_coordinates(river_mouths_sf)[,2],
     labels = river_mouths_sf$RIVER_NAME,
     pos = 3,  # Above the points
     cex = 0.7,
     col = "black",
     font = 2)  # Bold

# Add legend
legend("topright",
       legend = c("Water Areas", "Watersheds", "River Mouths"),
       fill = c("lightblue", "gray", NA),
       pch = c(NA, NA, 21),
       pt.bg = c(NA, NA, "red"),
       pt.cex = c(NA, NA, 1.5),
       cex = 0.8,
       bg = "white")
```

## 4. Calculate Agricultural Exposure

```{r exposure-calculation}

# Set up grid system
bbox_utm <- list(rbind(c(xmin, ymin),
                       c(xmax, ymin),
                       c(xmax, ymax),
                       c(xmin, ymax),
                       c(xmin, ymin))) %>%
  st_polygon() %>%
  st_sfc(., crs = target_crs)

grid_res <- 200
grid_points <- st_make_grid(bbox_utm,
                           cellsize = grid_res,
                           what = "centers") %>%
  st_geometry()

grid_points_sf <- st_sf(grid_points)

# Create template raster
template_raster <- raster(extent(bathy_200),
                         resolution = 200,
                         crs = projection(bathy_200))

# Create transition function
fun_bathy <- function(x) {
  ifelse(x[1] > x[2],
         pmax(0.001, 1 - abs((x[2] - x[1]) / x[2])),
         0.45)
}

# Create transition layer
tr_bathy <- transition(bathy_200,
                      transitionFunction = fun_bathy,
                      directions = 8,
                      symm = FALSE) %>%
  geoCorrection(., type = "c")

# Define RelativeExposure function
RelativeExposure <- function(source, transition, decay_type, grid_points_sf, empty_raster) {
  source_coords <- st_coordinates(source)
  source_sp <- SpatialPoints(coords = source_coords,
                            proj4string = CRS(st_crs(source)$proj4string))
  
  grid_points_sp <- as(grid_points_sf, "Spatial")
  
  distance <- costDistance(transition, grid_points_sp, source_sp)
  min_dist <- apply(distance, 1, min)
  
  a_param <- switch(decay_type,
                    "I" = -1,
                    "II" = -0.1,
                    "III" = -0.01,
                    "IV" = -0.001)
  
  exposure <- exp((0.000025 * a_param) * (min_dist)^2)
  
  coords <- st_coordinates(grid_points_sf)
  sp_exposure <- SpatialPointsDataFrame(
    coords = coords,
    data = data.frame(exposure = exposure),
    proj4string = CRS(st_crs(empty_raster)$proj4string)
  )
  
  exposure_rast <- rasterize(sp_exposure, empty_raster,
                            field = "exposure", fun = mean, background = NA)
  
  max_value <- cellStats(exposure_rast, stat = "max", na.rm = TRUE)
  exposure_rast[] <- exposure_rast[] / max_value
  
  return(exposure_rast)
}

# Filter river mouths with agriculture data and merge intensity index
active_river_mouths <- river_mouth_sf %>%
  left_join(
    watershed_agriculture_fixed %>% 
      select(RIVER_NAME, total_cultivated_area_ha, intensity_index),
    by = "RIVER_NAME"
  ) %>%
  filter(!is.na(intensity_index) & intensity_index > 0)

print(paste("Processing", nrow(active_river_mouths), "river mouths with agricultural activity"))

# Calculate exposure for each river mouth weighted by intensity
decay_type <- "III"
river_exposures <- list()

for (i in 1:nrow(active_river_mouths)) {
  river_name <- active_river_mouths$RIVER_NAME[i]
  intensity <- active_river_mouths$intensity_index[i]
  
  print(paste("Processing", river_name, "- Intensity:", round(intensity, 4)))
  
  river_point <- active_river_mouths[i, ]
  
  tryCatch({
    current_exposure <- RelativeExposure(
      river_point, tr_bathy, decay_type, grid_points_sf, template_raster
    )
    # Weight by intensity index
    river_exposures[[i]] <- current_exposure * intensity
    print(paste("Completed", river_name))
  }, error = function(e) {
    print(paste("Error processing", river_name, ":", e$message))
    river_exposures[[i]] <- NULL
  })
}

# Combine all weighted exposures
print("Combining all weighted river exposures...")
valid_exposures <- river_exposures[!sapply(river_exposures, is.null)]
combined_exposure <- Reduce('+', valid_exposures)

# Normalize to 0-1
max_val <- cellStats(combined_exposure, stat = "max", na.rm = TRUE)
combined_exposure <- combined_exposure / max_val

# Set 0 values to NA for better visualization
combined_exposure[combined_exposure == 0] <- NA

# Save the final exposure
agri_exp <- combined_exposure
save(agri_exp, file = "agri_exp_final.RData")

print("\n=== AGRICULTURE EXPOSURE COMPLETE ===")
print(paste("Max exposure:", round(max_val, 6)))
print(paste("Rivers processed:", length(valid_exposures)))
```

## 5. Final Visualization

```{r final-plot}
png("agriIII.png")
# Create simple visualization (your original approach)
plot(agri_exp,
     main = "Agricultural Exposure from River Watersheds\n(Level III decay)",
     xlim = c(xmin, xmax),
     ylim = c(ymin, ymax))
# Add scale bar
scalebar(d = 10000,  # distance in meters (adjust based on your map size)
         xy = NULL,   # NULL = bottom left corner
         type = "bar",
         divs = 2,
         below = "km",
         label = c(0, 5, 10))

dev.off()
```

## Results Summary

```{r results-summary}
# Display corrected watershed results
knitr::kable(
  watershed_agriculture_fixed %>%
    select(RIVER_NAME, total_cultivated_area_ha, relative_contribution) %>%
    mutate(
      total_cultivated_area_ha = round(total_cultivated_area_ha, 1),
      relative_contribution_pct = round(relative_contribution * 100, 1)
    ) %>%
    select(RIVER_NAME, total_cultivated_area_ha, relative_contribution_pct),
  caption = "Corrected Watershed Agricultural Contributions",
  col.names = c("Watershed", "Cultivated Area (ha)", "Contribution (%)")
)
```

## Summary

This analysis successfully quantified agricultural exposure patterns in the Saguenay Fjord based on:

1. **`r nrow(active_river_mouths)` active watersheds** with measurable agricultural activity
2. **`r round(sum(active_river_mouths$total_cultivated_area_ha), 0)` hectares** of total cultivated area  
3. **Chicoutimi watershed** as the dominant contributor (`r round(watershed_agriculture_fixed$relative_contribution[watershed_agriculture_fixed$RIVER_NAME == "chicoutimi"] * 100, 1)`% of total exposure)

The exposure model incorporates bathymetric constraints and uses a Level IV decay function to represent the spatial distribution of agricultural runoff potential throughout the fjord system.







